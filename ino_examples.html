

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Arduino examples &mdash; RF24 Revemped 2.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/darkness.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Linux examples" href="cpp_examples.html" />
    <link rel="prev" title="Welcome to RF24 Revemped’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> RF24 Revemped
          

          
            
            <img src="_static/Logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Arduino examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#gettingstarted-ino">GettingStarted.ino</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acknowledgementpayloads-ino">AcknowledgementPayloads.ino</a></li>
<li class="toctree-l2"><a class="reference internal" href="#manualacknowledgements-ino">ManualAcknowledgements.ino</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multiceiverdemo-ino">MulticeiverDemo.ino</a></li>
<li class="toctree-l2"><a class="reference internal" href="#streamingdata-ino">StreamingData.ino</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interruptconfigure-ino">InterruptConfigure.ino</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cpp_examples.html">Linux examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="attiny_examples.html">ATTiny examples</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="basic_api.html">Basic API</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_api.html">Advanced API</a></li>
<li class="toctree-l1"><a class="reference internal" href="configure_api.html">Configuration API</a></li>
</ul>
<p class="caption"><span class="caption-text">Related Pages</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common_issues.html">Common Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="arduino.html">Arduino</a></li>
<li class="toctree-l1"><a class="reference internal" href="attiny.html">ATTiny Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="linux_install.html">Linux Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="mraa.html">MRAA</a></li>
<li class="toctree-l1"><a class="reference internal" href="rpi_general.html">General Linux/Raspberry Pi</a></li>
<li class="toctree-l1"><a class="reference internal" href="cross_compilation.html">Linux cross-compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="atxmega.html">ATXMEGA</a></li>
<li class="toctree-l1"><a class="reference internal" href="portability.html">RF24 Portability</a></li>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Templated Files for Platform Support</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">RF24 Revemped</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Arduino examples</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/ino_examples.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arduino-examples">
<h1>Arduino examples<a class="headerlink" href="#arduino-examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="gettingstarted-ino">
<h2>GettingStarted.ino<a class="headerlink" href="#gettingstarted-ino" title="Permalink to this headline">¶</a></h2>
<p>A simple example of sending data from 1 nRF24L01 transceiver to another.
This example was written to be used on 2 devices acting as “nodes”.
Use the Serial Monitor to change each node’s behavior.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">/examples/GettingStarted/GettingStarted.ino</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;printf.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;RF24Revamped.h&quot;</span><span class="cp"></span>

<span class="c1">// instantiate an object for the nRF24L01 transceiver</span>
<span class="n">RF24</span> <span class="nf">radio</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// using pin 7 for the CE pin, and pin 8 for the CSN pin</span>

<span class="c1">// Let these addresses be used for the pair</span>
<span class="kt">uint8_t</span> <span class="n">address</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;1Node&quot;</span><span class="p">,</span> <span class="s">&quot;2Node&quot;</span><span class="p">};</span>
<span class="c1">// It is very helpful to think of an address as a path instead of as</span>
<span class="c1">// an identifying device destination</span>

<span class="c1">// to use different addresses on a pair of radios, we need a variable to</span>
<span class="c1">// uniquely identify which address this radio will use to transmit</span>
<span class="kt">bool</span> <span class="n">radioNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 0 uses address[0] to transmit, 1 uses address[1] to transmit</span>

<span class="c1">// Used to control whether this node is sending or receiving</span>
<span class="kt">bool</span> <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// true = TX role, false = RX role</span>

<span class="c1">// For this example, we&#39;ll be using a payload containing</span>
<span class="c1">// a single float number that will be incremented</span>
<span class="c1">// on every successful transmission</span>
<span class="kt">float</span> <span class="n">payload</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some boards need to wait to ensure access to serial over USB</span>
  <span class="p">}</span>

  <span class="c1">// initialize the transceiver on the SPI bus</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radio hardware is not responding!!&quot;</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// hold in infinite loop</span>
  <span class="p">}</span>

  <span class="c1">// print example&#39;s introductory prompt</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RF24/examples/GettingStarted&quot;</span><span class="p">));</span>

  <span class="c1">// To set the radioNumber via the Serial monitor on startup</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Which radio is this? Enter &#39;0&#39; or &#39;1&#39;. Defaults to &#39;0&#39;&quot;</span><span class="p">));</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// wait for user input</span>
  <span class="p">}</span>
  <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">parseInt</span><span class="p">();</span>
  <span class="n">radioNumber</span> <span class="o">=</span> <span class="n">input</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radioNumber = &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">radioNumber</span><span class="p">);</span>

  <span class="c1">// role variable is hardcoded to RX behavior, inform the user of this</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** PRESS &#39;T&#39; to begin transmitting to the other node&quot;</span><span class="p">));</span>

  <span class="c1">// Set the PA Level low to try preventing power supply related problems</span>
  <span class="c1">// because these examples are likely run with nodes in close proximity to</span>
  <span class="c1">// each other.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPaLevel</span><span class="p">(</span><span class="n">RF24_PA_LOW</span><span class="p">);</span>  <span class="c1">// RF24_PA_MAX is default.</span>

  <span class="c1">// save on transmission time by setting the radio to only transmit the</span>
  <span class="c1">// number of bytes we need to transmit a float</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPayloadLength</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span> <span class="c1">// float datatype occupies 4 bytes</span>

  <span class="c1">// set the TX address of the RX node into the TX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openWritingPipe</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">radioNumber</span><span class="p">]);</span>     <span class="c1">// always uses pipe 0</span>

  <span class="c1">// set the RX address of the TX node into a RX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openReadingPipe</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="o">!</span><span class="n">radioNumber</span><span class="p">]);</span> <span class="c1">// using pipe 1</span>

  <span class="c1">// additional setup specific to the node&#39;s role</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>  <span class="c1">// put radio in TX mode</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span> <span class="c1">// put radio in RX mode</span>
  <span class="p">}</span>

  <span class="c1">// For debugging info</span>
  <span class="c1">// printf_begin();       // needed only once for printing details</span>
  <span class="c1">// radio.printDetails();</span>

<span class="p">}</span> <span class="c1">// setup</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is a TX node</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                    <span class="c1">// start the timer</span>
    <span class="kt">bool</span> <span class="n">report</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">));</span>      <span class="c1">// transmit &amp; save the report</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                      <span class="c1">// end the timer</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission successful! &quot;</span><span class="p">));</span>          <span class="c1">// payload was delivered</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Time to transmit = &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">end_timer</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">);</span>                 <span class="c1">// print the timer result</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; us. Sent: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>                               <span class="c1">// print payload sent</span>
      <span class="n">payload</span> <span class="o">+=</span> <span class="mf">0.01</span><span class="p">;</span>                                       <span class="c1">// increment float payload</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission failed or timed out&quot;</span><span class="p">));</span> <span class="c1">// payload was not delivered</span>
    <span class="p">}</span>

    <span class="c1">// to make this example readable in the serial monitor</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// slow transmissions down by 1 second</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// This device is a RX node</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>              <span class="c1">// is there a payload?</span>
      <span class="kt">uint8_t</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">pipe</span><span class="p">();</span>        <span class="c1">// grab the pipe number that received it</span>
      <span class="kt">uint8_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">any</span><span class="p">();</span>        <span class="c1">// get the size of the payload</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>        <span class="c1">// fetch payload from FIFO</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Received &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>                <span class="c1">// print the size of the payload</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; bytes on pipe &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>                 <span class="c1">// print the pipe number</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>            <span class="c1">// print the payload&#39;s value</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// role</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// change the role via the serial monitor</span>

    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the TX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO TRANSMIT ROLE -- PRESS &#39;R&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the RX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO RECEIVE ROLE -- PRESS &#39;T&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span> <span class="c1">// loop</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="acknowledgementpayloads-ino">
<h2>AcknowledgementPayloads.ino<a class="headerlink" href="#acknowledgementpayloads-ino" title="Permalink to this headline">¶</a></h2>
<p>A simple example of sending data from 1 nRF24L01 transceiver to another with Acknowledgement (ACK) payloads attached to ACK packets.
This example was written to be used on 2 devices acting as “nodes”.
Use the Serial Monitor to change each node’s behavior.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">/examples/AcknowledgementPayloads/AcknowledgementPayloads.ino</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;printf.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;RF24Revamped.h&quot;</span><span class="cp"></span>

<span class="c1">// instantiate an object for the nRF24L01 transceiver</span>
<span class="n">RF24</span> <span class="nf">radio</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// using pin 7 for the CE pin, and pin 8 for the CSN pin</span>

<span class="c1">// an identifying device destination</span>
<span class="c1">// Let these addresses be used for the pair</span>
<span class="kt">uint8_t</span> <span class="n">address</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;1Node&quot;</span><span class="p">,</span> <span class="s">&quot;2Node&quot;</span><span class="p">};</span>
<span class="c1">// It is very helpful to think of an address as a path instead of as</span>
<span class="c1">// an identifying device destination</span>
<span class="c1">// to use different addresses on a pair of radios, we need a variable to</span>

<span class="c1">// uniquely identify which address this radio will use to transmit</span>
<span class="kt">bool</span> <span class="n">radioNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 0 uses address[0] to transmit, 1 uses address[1] to transmit</span>

<span class="c1">// Used to control whether this node is sending or receiving</span>
<span class="kt">bool</span> <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// true = TX role, false = RX role</span>

<span class="c1">// For this example, we&#39;ll be using a payload containing</span>
<span class="c1">// a string &amp; an integer number that will be incremented</span>
<span class="c1">// on every successful transmission.</span>
<span class="c1">// Make a data structure to store the entire payload of different datatypes</span>
<span class="k">struct</span> <span class="nc">PayloadStruct</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">message</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>          <span class="c1">// only using 6 characters for TX &amp; ACK payloads</span>
  <span class="kt">uint8_t</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">PayloadStruct</span> <span class="n">payload</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some boards need to wait to ensure access to serial over USB</span>
  <span class="p">}</span>

  <span class="c1">// initialize the transceiver on the SPI bus</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radio hardware is not responding!!&quot;</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// hold in infinite loop</span>
  <span class="p">}</span>

  <span class="c1">// print example&#39;s introductory prompt</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RF24/examples/AcknowledgementPayloads&quot;</span><span class="p">));</span>

  <span class="c1">// To set the radioNumber via the Serial monitor on startup</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Which radio is this? Enter &#39;0&#39; or &#39;1&#39;. Defaults to &#39;0&#39;&quot;</span><span class="p">));</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// wait for user input</span>
  <span class="p">}</span>
  <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">parseInt</span><span class="p">();</span>
  <span class="n">radioNumber</span> <span class="o">=</span> <span class="n">input</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radioNumber = &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">radioNumber</span><span class="p">);</span>

  <span class="c1">// role variable is hardcoded to RX behavior, inform the user of this</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** PRESS &#39;T&#39; to begin transmitting to the other node&quot;</span><span class="p">));</span>

  <span class="c1">// Set the PA Level low to try preventing power supply related problems</span>
  <span class="c1">// because these examples are likely run with nodes in close proximity to</span>
  <span class="c1">// each other.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPaLevel</span><span class="p">(</span><span class="n">RF24_PA_LOW</span><span class="p">);</span>     <span class="c1">// RF24_PA_MAX is default.</span>

  <span class="c1">// to use ACK payloads, we need to enable dynamic payload lengths (for all nodes)</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setDynamicPayloads</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>    <span class="c1">// ACK payloads are dynamically sized</span>

  <span class="c1">// Acknowledgement packets have no payloads by default. We need to enable</span>
  <span class="c1">// this feature for all nodes (TX &amp; RX) to use ACK payloads.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">enableAckPayload</span><span class="p">();</span>

  <span class="c1">// set the TX address of the RX node into the TX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openWritingPipe</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">radioNumber</span><span class="p">]);</span>     <span class="c1">// always uses pipe 0</span>

  <span class="c1">// set the RX address of the TX node into a RX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openReadingPipe</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="o">!</span><span class="n">radioNumber</span><span class="p">]);</span> <span class="c1">// using pipe 1</span>

  <span class="c1">// additional setup specific to the node&#39;s role</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// setup the TX payload</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;Hello &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>                       <span class="c1">// set the payload message</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                                      <span class="c1">// put radio in TX mode</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// setup the ACK payload &amp; load the first response into the FIFO</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;World &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>                       <span class="c1">// set the payload message</span>
    <span class="c1">// load the payload for the first received transmission on pipe 0</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PayloadStruct</span><span class="p">));</span>

    <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>                                     <span class="c1">// put radio in RX mode</span>
  <span class="p">}</span>

  <span class="c1">// For debugging info</span>
  <span class="c1">// printf_begin();       // needed only once for printing details</span>
  <span class="c1">// radio.printDetails();</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is a TX node</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                <span class="c1">// start the timer</span>
    <span class="kt">bool</span> <span class="n">report</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span> <span class="c1">// transmit &amp; save the report</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                  <span class="c1">// end the timer</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission successful! &quot;</span><span class="p">));</span> <span class="c1">// payload was delivered</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Time to transmit = &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">end_timer</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">);</span>        <span class="c1">// print the timer result</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; us. Sent: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>                <span class="c1">// print the outgoing message</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>                <span class="c1">// print the outgoing counter</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>                      <span class="c1">// is there an ACK payload?</span>
        <span class="kt">uint8_t</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">pipe</span><span class="p">();</span>                <span class="c1">// get the pipe number that received it</span>
        <span class="n">PayloadStruct</span> <span class="n">received</span><span class="p">;</span>
        <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">received</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">received</span><span class="p">));</span>    <span class="c1">// get incoming ACK payload</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Recieved &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">any</span><span class="p">());</span>                  <span class="c1">// print incoming payload size</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; bytes on pipe &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>                         <span class="c1">// print pipe number that received the ACK</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;: &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>             <span class="c1">// print incoming message</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>           <span class="c1">// print incoming counter</span>

        <span class="c1">// save incoming counter &amp; increment for next outgoing</span>
        <span class="n">payload</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">received</span><span class="p">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// empty ACK packet received</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Recieved: an empty ACK packet&quot;</span><span class="p">));</span>
      <span class="p">}</span>


    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission failed or timed out&quot;</span><span class="p">));</span>    <span class="c1">// payload was not delivered</span>
    <span class="p">}</span>

    <span class="c1">// to make this example readable in the serial monitor</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// slow transmissions down by 1 second</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// This device is a RX node</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>                   <span class="c1">// is there a payload?</span>
      <span class="kt">uint8_t</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">pipe</span><span class="p">();</span>             <span class="c1">// grab the pipe number that received it</span>
      <span class="kt">uint8_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">any</span><span class="p">();</span>             <span class="c1">// get the size of the payload</span>
      <span class="n">PayloadStruct</span> <span class="n">received</span><span class="p">;</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">received</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">received</span><span class="p">));</span> <span class="c1">// get incoming payload</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Received &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>                     <span class="c1">// print the size of the payload</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; bytes on pipe &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>                      <span class="c1">// print the pipe number</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>          <span class="c1">// print incoming message</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>          <span class="c1">// print incoming counter</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Sent: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>           <span class="c1">// print outgoing message</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>         <span class="c1">// print outgoing counter</span>

      <span class="c1">// save incoming counter &amp; increment for next outgoing</span>
      <span class="n">payload</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">received</span><span class="p">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="c1">// load the payload for the first received transmission on pipe 0</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// role</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// change the role via the serial monitor</span>

    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the TX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO TRANSMIT ROLE -- PRESS &#39;R&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>

      <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;Hello &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// change payload message</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                <span class="c1">// this also discards any unused ACK payloads</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the RX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO RECEIVE ROLE -- PRESS &#39;T&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;World &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// change payload message</span>

      <span class="c1">// load the payload for the first received transmission on pipe 0</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PayloadStruct</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="c1">// loop</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="manualacknowledgements-ino">
<h2>ManualAcknowledgements.ino<a class="headerlink" href="#manualacknowledgements-ino" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example of using the RF24 class on a Raspberry Pi to transmit and respond with acknowledgment (ACK) transmissions. Notice that the auto-ack feature is enabled, but this example doesn’t use automatic ACK payloads because automatic ACK payloads’ data will always be outdated by 1 transmission. Instead, this example uses a call and response paradigm.
This example was written to be used on 2 devices acting as “nodes”.
Use the Serial Monitor to change each node’s behavior.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">/examples/ManualAcknowledgements/ManualAcknowledgements.ino</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;printf.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;RF24Revamped.h&quot;</span><span class="cp"></span>

<span class="c1">// instantiate an object for the nRF24L01 transceiver</span>
<span class="n">RF24</span> <span class="nf">radio</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// using pin 7 for the CE pin, and pin 8 for the CSN pin</span>

<span class="c1">// Let these addresses be used for the pair</span>
<span class="kt">uint8_t</span> <span class="n">address</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;1Node&quot;</span><span class="p">,</span> <span class="s">&quot;2Node&quot;</span><span class="p">};</span>
<span class="c1">// It is very helpful to think of an address as a path instead of as</span>
<span class="c1">// an identifying device destination</span>

<span class="c1">// to use different addresses on a pair of radios, we need a variable to</span>
<span class="c1">// uniquely identify which address this radio will use to transmit</span>
<span class="kt">bool</span> <span class="n">radioNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 0 uses address[0] to transmit, 1 uses address[1] to transmit</span>

<span class="c1">// Used to control whether this node is sending or receiving</span>
<span class="kt">bool</span> <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// true = TX node, false = RX node</span>

<span class="c1">// For this example, we&#39;ll be using a payload containing</span>
<span class="c1">// a string &amp; an integer number that will be incremented</span>
<span class="c1">// on every successful transmission.</span>
<span class="c1">// Make a data structure to store the entire payload of different datatypes</span>
<span class="k">struct</span> <span class="nc">PayloadStruct</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">message</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>          <span class="c1">// only using 6 characters for TX &amp; RX payloads</span>
  <span class="kt">uint8_t</span> <span class="n">counter</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">PayloadStruct</span> <span class="n">payload</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// append a NULL terminating character for printing as a c-string</span>
  <span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some boards need to wait to ensure access to serial over USB</span>
  <span class="p">}</span>

  <span class="c1">// initialize the transceiver on the SPI bus</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radio hardware is not responding!!&quot;</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// hold in infinite loop</span>
  <span class="p">}</span>

  <span class="c1">// print example&#39;s introductory prompt</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RF24/examples/ManualAcknowledgements&quot;</span><span class="p">));</span>

  <span class="c1">// To set the radioNumber via the Serial monitor on startup</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Which radio is this? Enter &#39;0&#39; or &#39;1&#39;. Defaults to &#39;0&#39;&quot;</span><span class="p">));</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// wait for user input</span>
  <span class="p">}</span>
  <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">parseInt</span><span class="p">();</span>
  <span class="n">radioNumber</span> <span class="o">=</span> <span class="n">input</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radioNumber = &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">radioNumber</span><span class="p">);</span>

  <span class="c1">// role variable is hardcoded to RX behavior, inform the user of this</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** PRESS &#39;T&#39; to begin transmitting to the other node&quot;</span><span class="p">));</span>

  <span class="c1">// Set the PA Level low to try preventing power supply related problems</span>
  <span class="c1">// because these examples are likely run with nodes in close proximity to</span>
  <span class="c1">// each other.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPaLevel</span><span class="p">(</span><span class="n">RF24_PA_LOW</span><span class="p">);</span> <span class="c1">// RF24_PA_MAX is default.</span>

  <span class="c1">// save on transmission time by setting the radio to only transmit the</span>
  <span class="c1">// number of bytes we need to transmit a float</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPayloadLength</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span> <span class="c1">// char[7] &amp; uint8_t datatypes occupy 8 bytes</span>

  <span class="c1">// set the TX address of the RX node into the TX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openWritingPipe</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">radioNumber</span><span class="p">]);</span>     <span class="c1">// always uses pipe 0</span>

  <span class="c1">// set the RX address of the TX node into a RX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openReadingPipe</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="o">!</span><span class="n">radioNumber</span><span class="p">]);</span> <span class="c1">// using pipe 1</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// setup the TX node</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;Hello &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// set the outgoing message</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                <span class="c1">// put radio in TX mode</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// setup the RX node</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;World &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// set the outgoing message</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>               <span class="c1">// put radio in RX mode</span>
  <span class="p">}</span>

  <span class="c1">// For debugging info</span>
  <span class="c1">// printf_begin();       // needed only once for printing details</span>
  <span class="c1">// radio.printDetails();</span>

<span class="p">}</span> <span class="c1">// setup()</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is a TX node</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                 <span class="c1">// start the timer</span>
    <span class="kt">bool</span> <span class="n">report</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span> <span class="c1">// transmit &amp; save the report</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// transmission successful; wait for response and print results</span>

      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>                                <span class="c1">// put in RX mode</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_timeout</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>                <span class="c1">// timer to detect timeout</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>                           <span class="c1">// wait for response</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_timeout</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>                  <span class="c1">// only wait 200 ms</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                    <span class="c1">// end the timer</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                                 <span class="c1">// put back in TX mode</span>

      <span class="c1">// print summary of transactions</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission successful!&quot;</span><span class="p">));</span> <span class="c1">// payload was delivered</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>                     <span class="c1">// is there a payload received</span>
        <span class="kt">uint8_t</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">pipe</span><span class="p">();</span>               <span class="c1">// grab the pipe number that received it</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Round-trip delay: &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">end_timer</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">);</span>     <span class="c1">// print the timer result</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; us. Sent: &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>             <span class="c1">// print the outgoing payload&#39;s message</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>             <span class="c1">// print outgoing payload&#39;s counter</span>
        <span class="n">PayloadStruct</span> <span class="n">received</span><span class="p">;</span>
        <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">received</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">received</span><span class="p">));</span>   <span class="c1">// get payload from RX FIFO</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Received &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">any</span><span class="p">());</span>                 <span class="c1">// print the size of the payload</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; bytes on pipe &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>                        <span class="c1">// print the pipe number</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;: &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>            <span class="c1">// print the incoming payload&#39;s message</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>          <span class="c1">// print the incoming payload&#39;s counter</span>
        <span class="n">payload</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">received</span><span class="p">.</span><span class="n">counter</span><span class="p">;</span>        <span class="c1">// save incoming counter for next outgoing counter</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// no response received</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Recieved no response.&quot;</span><span class="p">));</span>
      <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// payload was not delivered</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission failed or timed out&quot;</span><span class="p">));</span>
    <span class="p">}</span> <span class="c1">// report</span>

    <span class="c1">// to make this example readable in the serial monitor</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// slow transmissions down by 1 second</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// This device is a RX node</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>                   <span class="c1">// is there a payload?</span>
      <span class="kt">uint8_t</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">pipe</span><span class="p">();</span>             <span class="c1">// grab the pipe number that received it</span>
      <span class="n">PayloadStruct</span> <span class="n">received</span><span class="p">;</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">received</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">received</span><span class="p">));</span> <span class="c1">// get incoming payload</span>
      <span class="n">payload</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">received</span><span class="p">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// increment incoming counter for next outgoing response</span>

      <span class="c1">// transmit response &amp; save result to `report`</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                                <span class="c1">// put in TX mode</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_response</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
      <span class="kt">bool</span> <span class="n">report</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>  <span class="c1">// send response</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">report</span> <span class="o">&amp;&amp;</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_response</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">resend</span><span class="p">();</span>                            <span class="c1">// retry for 200 ms</span>
      <span class="p">}</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>                               <span class="c1">// put back in RX mode</span>

      <span class="c1">// print summary of transactions</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Received &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">any</span><span class="p">());</span>          <span class="c1">// print the size of the payload</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; bytes on pipe &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>                 <span class="c1">// print the pipe number</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>     <span class="c1">// print incoming message</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>     <span class="c1">// print incoming counter</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Sent: &quot;</span><span class="p">));</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>       <span class="c1">// print outgoing message</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>     <span class="c1">// print outgoing counter</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot; Response failed.&quot;</span><span class="p">);</span> <span class="c1">// failed to send response</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// role</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// change the role via the serial monitor</span>

    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the TX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;Hello &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// set the outgoing message</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO TRANSMIT ROLE -- PRESS &#39;R&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                <span class="c1">// put in TX mode</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the RX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;World &quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="c1">// set the response message</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO RECEIVE ROLE -- PRESS &#39;T&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>               <span class="c1">// put in RX mode</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="c1">// loop</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="multiceiverdemo-ino">
<h2>MulticeiverDemo.ino<a class="headerlink" href="#multiceiverdemo-ino" title="Permalink to this headline">¶</a></h2>
<p>A simple example of sending data from as many as 6 nRF24L01 transceivers to 1 receiving transceiver. This technique is trademarked by Nordic Semiconductors as “MultiCeiver”.
Use the Serial Monitor to change each node’s behavior.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">/examples/MulticeiverDemo/MulticeiverDemo.ino</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;printf.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;RF24Revamped.h&quot;</span><span class="cp"></span>

<span class="c1">// instantiate an object for the nRF24L01 transceiver</span>
<span class="n">RF24</span> <span class="nf">radio</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// using pin 7 for the CE pin, and pin 8 for the CSN pin</span>

<span class="c1">// For this example, we&#39;ll be using 6 addresses; 1 for each TX node</span>
<span class="c1">// It is very helpful to think of an address as a path instead of as</span>
<span class="c1">// an identifying device destination</span>
<span class="c1">// Notice that the last byte is the only byte that changes in the last 5</span>
<span class="c1">// addresses. This is a limitation of the nRF24L01 transceiver for pipes 2-5</span>
<span class="c1">// because they use the same first 4 bytes from pipe 1.</span>
<span class="kt">uint64_t</span> <span class="n">address</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x7878787878LL</span><span class="p">,</span>
                       <span class="mh">0xB3B4B5B6F1LL</span><span class="p">,</span>
                       <span class="mh">0xB3B4B5B6CDLL</span><span class="p">,</span>
                       <span class="mh">0xB3B4B5B6A3LL</span><span class="p">,</span>
                       <span class="mh">0xB3B4B5B60FLL</span><span class="p">,</span>
                       <span class="mh">0xB3B4B5B605LL</span>
                      <span class="p">};</span>

<span class="c1">// Because this example allow up to 6 nodes (specified by numbers 0-5) to</span>
<span class="c1">// transmit and only 1 node to receive, we will use a negative value in our</span>
<span class="c1">// role variable to signify this node is a receiver.</span>
<span class="c1">// role variable is used to control whether this node is sending or receiving</span>
<span class="kt">char</span> <span class="n">role</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span> <span class="c1">// 0-5 = TX node; any negative number = RX node</span>

<span class="c1">// For this example, we&#39;ll be using a payload containing</span>
<span class="c1">// a node ID number and a single integer number that will be incremented</span>
<span class="c1">// on every successful transmission.</span>
<span class="c1">// Make a data structure to use as a payload.</span>
<span class="k">struct</span> <span class="nc">PayloadStruct</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nodeID</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">payloadID</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">PayloadStruct</span> <span class="n">payload</span><span class="p">;</span>

<span class="c1">// This example uses all 6 pipes to receive while TX nodes only use 2 pipes</span>
<span class="c1">// To make this easier we&#39;ll use a function to manage the addresses, and the</span>
<span class="c1">// payload&#39;s nodeID</span>
<span class="kt">void</span> <span class="nf">setRole</span><span class="p">();</span> <span class="c1">// declare a prototype; definition is found after the loop()</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some boards need to wait to ensure access to serial over USB</span>
  <span class="p">}</span>

  <span class="c1">// initialize the transceiver on the SPI bus</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radio hardware is not responding!!&quot;</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// hold in infinite loop</span>
  <span class="p">}</span>

  <span class="c1">// print example&#39;s introductory prompt</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RF24/examples/MulticeiverDemo&quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** Enter a number between 0 and 5 (inclusive) to change&quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;    the identifying node number that transmits.&quot;</span><span class="p">));</span>

  <span class="c1">// Set the PA Level low to try preventing power supply related problems</span>
  <span class="c1">// because these examples are likely run with nodes in close proximity of</span>
  <span class="c1">// each other.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPaLevel</span><span class="p">(</span><span class="n">RF24_PA_LOW</span><span class="p">);</span> <span class="c1">// RF24_PA_MAX is default.</span>

  <span class="c1">// save on transmission time by setting the radio to only transmit the</span>
  <span class="c1">// number of bytes we need to transmit a float</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPayloadLength</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span> <span class="c1">// 2x int datatype occupy 8 bytes</span>

  <span class="c1">// Set the pipe addresses accordingly. This function additionally also</span>
  <span class="c1">// calls startListening() or stopListening() and sets the payload&#39;s nodeID</span>
  <span class="n">setRole</span><span class="p">();</span>

  <span class="c1">// For debugging info</span>
  <span class="c1">// printf_begin();       // needed only once for printing details</span>
  <span class="c1">// radio.printDetails();</span>

<span class="p">}</span> <span class="c1">// setup()</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">&lt;=</span> <span class="mi">53</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is a TX node</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                    <span class="c1">// start the timer</span>
    <span class="kt">bool</span> <span class="n">report</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payload</span><span class="p">));</span>    <span class="c1">// transmit &amp; save the report</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>                      <span class="c1">// end the timer</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// payload was delivered</span>

      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission of payloadID &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">payloadID</span><span class="p">);</span>                       <span class="c1">// print payloadID</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; as node &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">nodeID</span><span class="p">);</span>                          <span class="c1">// print nodeID</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; successful!&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; Time to transmit: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">end_timer</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">);</span>                 <span class="c1">// print the timer result</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; us&quot;</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission failed or timed out&quot;</span><span class="p">));</span> <span class="c1">// payload was not delivered</span>
    <span class="p">}</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">payloadID</span><span class="o">++</span><span class="p">;</span>                                     <span class="c1">// increment payload number</span>

    <span class="c1">// to make this example readable in the serial monitor</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span> <span class="c1">// slow transmissions down by 1 second</span>

  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is the RX node</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>              <span class="c1">// is there a payload?</span>
      <span class="kt">uint8_t</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">pipe</span><span class="p">();</span>        <span class="c1">// grab the pipe number that received it</span>
      <span class="kt">uint8_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">radio</span><span class="p">.</span><span class="n">any</span><span class="p">();</span>        <span class="c1">// get the size of the payload</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>        <span class="c1">// fetch payload from FIFO</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Received &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>                <span class="c1">// print the size of the payload</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; bytes on pipe &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>                 <span class="c1">// print the pipe number</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; from node &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">nodeID</span><span class="p">);</span>       <span class="c1">// print the payload&#39;s origin</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;. PayloadID: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">payloadID</span><span class="p">);</span>  <span class="c1">// print the payload&#39;s number</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// role</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// change the role via the serial monitor</span>

    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">toupper</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">role</span> <span class="o">&lt;=</span> <span class="mi">53</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the RX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING ROLE TO RECEIVER ***&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;--- Enter a number between 0 and 5 (inclusive) to act as&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;    a unique node number that transmits to the RX node.&quot;</span><span class="p">));</span>
      <span class="n">setRole</span><span class="p">();</span> <span class="c1">// change address on all pipes to TX nodes</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">53</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become a TX node with identifier &#39;c&#39;</span>

      <span class="n">role</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">48</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING ROLE TO NODE &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; ***&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;--- Enter a number between 0 and 5 (inclusive) to change&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;    the identifying node number that transmits.&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;--- PRESS &#39;R&#39; to act as the RX node.&quot;</span><span class="p">));</span>
      <span class="n">setRole</span><span class="p">();</span> <span class="c1">// change address on pipe 0 to the RX node</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span> <span class="c1">// loop</span>

<span class="kt">void</span> <span class="nf">setRole</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// For the RX node</span>

    <span class="c1">// Set the addresses for all pipes to TX nodes</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">openReadingPipe</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span> <span class="c1">// put radio in RX mode</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// For the TX node</span>

    <span class="c1">// set the payload&#39;s nodeID &amp; reset the payload&#39;s identifying number</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">nodeID</span> <span class="o">=</span> <span class="n">role</span><span class="p">;</span>
    <span class="n">payload</span><span class="p">.</span><span class="n">payloadID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// Set the address on pipe 0 to the RX node.</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span> <span class="c1">// put radio in TX mode</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">openWritingPipe</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">role</span><span class="p">]);</span>

    <span class="c1">// According to the datasheet, the auto-retry features&#39;s delay value should</span>
    <span class="c1">// be &quot;skewed&quot; to allow the RX node to receive 1 transmission at a time.</span>
    <span class="c1">// So, use varying delay between retry attempts and 15 (at most) retry attempts</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">setRetries</span><span class="p">(((</span><span class="n">role</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span> <span class="c1">// maximum value is 15 for both args</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="c1">// setRole</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="streamingdata-ino">
<h2>StreamingData.ino<a class="headerlink" href="#streamingdata-ino" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example of using the RF24 class on a Raspberry Pi for streaming multiple payloads.
This example was written to be used on 2 devices acting as “nodes”.
Use the Serial Monitor to change each node’s behavior.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">/examples/StreamingData/StreamingData.ino</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;printf.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;RF24Revamped.h&quot;</span><span class="cp"></span>

<span class="c1">// instantiate an object for the nRF24L01 transceiver</span>
<span class="n">RF24</span> <span class="nf">radio</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// using pin 7 for the CE pin, and pin 8 for the CSN pin</span>

<span class="c1">// Let these addresses be used for the pair</span>
<span class="kt">uint8_t</span> <span class="n">address</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;1Node&quot;</span><span class="p">,</span> <span class="s">&quot;2Node&quot;</span><span class="p">};</span>
<span class="c1">// It is very helpful to think of an address as a path instead of as</span>
<span class="c1">// an identifying device destination</span>

<span class="c1">// to use different addresses on a pair of radios, we need a variable to</span>
<span class="c1">// uniquely identify which address this radio will use to transmit</span>
<span class="kt">bool</span> <span class="n">radioNumber</span><span class="p">;</span> <span class="c1">// 0 uses address[0] to transmit, 1 uses address[1] to transmit</span>

<span class="c1">// Used to control whether this node is sending or receiving</span>
<span class="kt">bool</span> <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// true = TX node, false = RX node</span>

<span class="c1">// For this example, we&#39;ll be sending 32 payloads each containing</span>
<span class="c1">// 32 bytes of data that looks like ASCII art when printed to the serial</span>
<span class="c1">// monitor. The TX node and RX node needs only a single 32 byte buffer.</span>
<span class="cp">#define SIZE 32            </span><span class="c1">// this is the maximum for this example. (minimum is 1)</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>     <span class="c1">// for the RX node</span>
<span class="kt">uint8_t</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="c1">// for counting the number of received payloads</span>
<span class="kt">void</span> <span class="nf">makePayload</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span> <span class="c1">// prototype to construct a payload dynamically</span>


<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">buffer</span><span class="p">[</span><span class="n">SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="c1">// add a NULL terminating character (for easy printing)</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some boards need to wait to ensure access to serial over USB</span>
  <span class="p">}</span>

  <span class="c1">// initialize the transceiver on the SPI bus</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radio hardware is not responding!!&quot;</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// hold in infinite loop</span>
  <span class="p">}</span>

  <span class="c1">// print example&#39;s introductory prompt</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RF24/examples/StreamingData&quot;</span><span class="p">));</span>

  <span class="c1">// To set the radioNumber via the Serial monitor on startup</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Which radio is this? Enter &#39;0&#39; or &#39;1&#39;. Defaults to &#39;0&#39;&quot;</span><span class="p">));</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// wait for user input</span>
  <span class="p">}</span>
  <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">parseInt</span><span class="p">();</span>
  <span class="n">radioNumber</span> <span class="o">=</span> <span class="n">input</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radioNumber = &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">radioNumber</span><span class="p">);</span>

  <span class="c1">// role variable is hardcoded to RX behavior, inform the user of this</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** PRESS &#39;T&#39; to begin transmitting to the other node&quot;</span><span class="p">));</span>

  <span class="c1">// Set the PA Level low to try preventing power supply related problems</span>
  <span class="c1">// because these examples are likely run with nodes in close proximity to</span>
  <span class="c1">// each other.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPaLevel</span><span class="p">(</span><span class="n">RF24_PA_LOW</span><span class="p">);</span>  <span class="c1">// RF24_PA_MAX is default.</span>

  <span class="c1">// save on transmission time by setting the radio to only transmit the</span>
  <span class="c1">// number of bytes we need to transmit</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPayloadLength</span><span class="p">(</span><span class="n">SIZE</span><span class="p">);</span>     <span class="c1">// default value is the maximum 32 bytes</span>

  <span class="c1">// set the TX address of the RX node into the TX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openWritingPipe</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">radioNumber</span><span class="p">]);</span>     <span class="c1">// always uses pipe 0</span>

  <span class="c1">// set the RX address of the TX node into a RX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openReadingPipe</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="o">!</span><span class="n">radioNumber</span><span class="p">]);</span> <span class="c1">// using pipe 1</span>

  <span class="c1">// additional setup specific to the node&#39;s role</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>  <span class="c1">// put radio in TX mode</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span> <span class="c1">// put radio in RX mode</span>
  <span class="p">}</span>

  <span class="c1">// For debugging info</span>
  <span class="c1">// printf_begin();       // needed only once for printing details</span>
  <span class="c1">// radio.printDetails();</span>

<span class="p">}</span> <span class="c1">// setup()</span>


<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is a TX node</span>

    <span class="n">radio</span><span class="p">.</span><span class="n">flushTx</span><span class="p">();</span>
    <span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">makePayload</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>                           <span class="c1">// make the payload</span>
    <span class="kt">uint8_t</span> <span class="n">failures</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>       <span class="c1">// start the timer</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">failures</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">makePayload</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>                           <span class="c1">// make the payload</span>
      <span class="p">}</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">ce</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">isFifo</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDf</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">failures</span><span class="o">++</span><span class="p">;</span>
          <span class="n">radio</span><span class="p">.</span><span class="n">ce</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
          <span class="n">radio</span><span class="p">.</span><span class="n">clearStatusFlags</span><span class="p">();</span>
          <span class="n">radio</span><span class="p">.</span><span class="n">ce</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">failures</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Too many failures detected. Aborting at payload &quot;</span><span class="p">));</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">ce</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_timer</span> <span class="o">=</span> <span class="n">micros</span><span class="p">();</span>         <span class="c1">// end the timer</span>

    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Time to transmit = &quot;</span><span class="p">));</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">end_timer</span> <span class="o">-</span> <span class="n">start_timer</span><span class="p">);</span>      <span class="c1">// print the timer result</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; us with &quot;</span><span class="p">));</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">failures</span><span class="p">);</span>                     <span class="c1">// print failures detected</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; failures detected&quot;</span><span class="p">));</span>

    <span class="c1">// to make this example readable in the serial monitor</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  <span class="c1">// slow transmissions down by 1 second</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// This device is a RX node</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>         <span class="c1">// is there a payload?</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">);</span>     <span class="c1">// fetch payload from FIFO</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Received: &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>          <span class="c1">// print the payload&#39;s value</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">counter</span><span class="o">++</span><span class="p">);</span>     <span class="c1">// print the received counter</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// role</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// change the role via the serial monitor</span>

    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the TX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//reset the RX node&#39;s counter</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO TRANSMIT ROLE -- PRESS &#39;R&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the RX node</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO RECEIVE ROLE -- PRESS &#39;T&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span> <span class="c1">// loop</span>


<span class="kt">void</span> <span class="nf">makePayload</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Make a single payload based on position in stream.</span>
  <span class="c1">// This example employs function to save memory on certain boards.</span>

  <span class="c1">// let the first character be an identifying alphanumeric prefix</span>
  <span class="c1">// this lets us see which payload didn&#39;t get received</span>
  <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">26</span> <span class="o">?</span> <span class="mi">65</span> <span class="o">:</span> <span class="mi">71</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">chr</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">abs</span><span class="p">((</span><span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">chr</span> <span class="o">|=</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">abs</span><span class="p">((</span><span class="n">SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chr</span> <span class="o">+</span> <span class="mi">48</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="interruptconfigure-ino">
<h2>InterruptConfigure.ino<a class="headerlink" href="#interruptconfigure-ino" title="Permalink to this headline">¶</a></h2>
<p>This is a simple example of using the RF24 class on a Raspberry Pi to detecting (and verifying) the IRQ (interrupt) pin on the nRF24L01.
This example was written to be used on 2 devices acting as “nodes”.
Use the Serial Monitor to change each node’s behavior.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">/examples/InterruptConfigure/InterruptConfigure.ino</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;printf.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;RF24Revamped.h&quot;</span><span class="cp"></span>

<span class="c1">// We will be using the nRF24L01&#39;s IRQ pin for this example</span>
<span class="cp">#define IRQ_PIN 2 </span><span class="c1">// this needs to be a digital input capable pin</span>
<span class="k">volatile</span> <span class="kt">bool</span> <span class="n">wait_for_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// used to wait for an IRQ event to trigger</span>

<span class="c1">// instantiate an object for the nRF24L01 transceiver</span>
<span class="n">RF24</span> <span class="nf">radio</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// using pin 7 for the CE pin, and pin 8 for the CSN pin</span>

<span class="c1">// Let these addresses be used for the pair</span>
<span class="kt">uint8_t</span> <span class="n">address</span><span class="p">[][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;1Node&quot;</span><span class="p">,</span> <span class="s">&quot;2Node&quot;</span><span class="p">};</span>
<span class="c1">// It is very helpful to think of an address as a path instead of as</span>
<span class="c1">// an identifying device destination</span>

<span class="c1">// to use different addresses on a pair of radios, we need a variable to</span>
<span class="c1">// uniquely identify which address this radio will use to transmit</span>
<span class="kt">bool</span> <span class="n">radioNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 0 uses address[0] to transmit, 1 uses address[1] to transmit</span>

<span class="c1">// Used to control whether this node is sending or receiving</span>
<span class="kt">bool</span> <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>  <span class="c1">// true = TX node, false = RX node</span>

<span class="c1">// For this example, we&#39;ll be using a payload containing</span>
<span class="c1">// a string that changes on every transmission. (successful or not)</span>
<span class="c1">// Make a couple arrays of payloads &amp; an iterator to traverse them</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">tx_pl_size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">ack_pl_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="kt">uint8_t</span> <span class="n">pl_iterator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// The &quot; + 1&quot; compensates for the c-string&#39;s NULL terminating 0</span>
<span class="kt">char</span> <span class="n">tx_payloads</span><span class="p">[][</span><span class="n">tx_pl_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Ping &quot;</span><span class="p">,</span> <span class="s">&quot;Pong &quot;</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">,</span> <span class="s">&quot;1FAIL&quot;</span><span class="p">};</span>
<span class="kt">char</span> <span class="n">ack_payloads</span><span class="p">[][</span><span class="n">ack_pl_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Yak &quot;</span><span class="p">,</span> <span class="s">&quot;Back&quot;</span><span class="p">,</span> <span class="s">&quot; ACK&quot;</span><span class="p">};</span>

<span class="kt">void</span> <span class="nf">interruptHandler</span><span class="p">();</span> <span class="c1">// prototype to handle IRQ events</span>
<span class="kt">void</span> <span class="nf">printRxFifo</span><span class="p">();</span>      <span class="c1">// prototype to print RX FIFO with 1 buffer</span>


<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// some boards need to wait to ensure access to serial over USB</span>
  <span class="p">}</span>

  <span class="c1">// initialize the transceiver on the SPI bus</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radio</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radio hardware is not responding!!&quot;</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// hold in infinite loop</span>
  <span class="p">}</span>

  <span class="c1">// print example&#39;s introductory prompt</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RF24/examples/InterruptConfigure&quot;</span><span class="p">));</span>

  <span class="c1">// To set the radioNumber via the Serial monitor on startup</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Which radio is this? Enter &#39;0&#39; or &#39;1&#39;. Defaults to &#39;0&#39;&quot;</span><span class="p">));</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// wait for user input</span>
  <span class="p">}</span>
  <span class="kt">char</span> <span class="n">input</span> <span class="o">=</span> <span class="n">Serial</span><span class="p">.</span><span class="n">parseInt</span><span class="p">();</span>
  <span class="n">radioNumber</span> <span class="o">=</span> <span class="n">input</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;radioNumber = &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">radioNumber</span><span class="p">);</span>

  <span class="c1">// role variable is hardcoded to RX behavior, inform the user of this</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** PRESS &#39;T&#39; to begin transmitting to the other node&quot;</span><span class="p">));</span>

  <span class="c1">// setup the IRQ_PIN</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">IRQ_PIN</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
  <span class="n">attachInterrupt</span><span class="p">(</span><span class="n">digitalPinToInterrupt</span><span class="p">(</span><span class="n">IRQ_PIN</span><span class="p">),</span> <span class="n">interruptHandler</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>
  <span class="c1">// IMPORTANT: do not call radio.available() before calling</span>
  <span class="c1">// radio.clearStatusFlags() when the interruptHandler() is triggered by the</span>
  <span class="c1">// IRQ pin FALLING event. According to the datasheet, the pipe information</span>
  <span class="c1">// is unreliable during the IRQ pin FALLING transition.</span>

  <span class="c1">// Set the PA Level low to try preventing power supply related problems</span>
  <span class="c1">// because these examples are likely run with nodes in close proximity to</span>
  <span class="c1">// each other.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setPaLevel</span><span class="p">(</span><span class="n">RF24_PA_LOW</span><span class="p">);</span>    <span class="c1">// RF24_PA_MAX is default.</span>

  <span class="c1">// For this example we use acknowledgment (ACK) payloads to trigger the</span>
  <span class="c1">// IRQ pin when data is received on the TX node.</span>
  <span class="c1">// to use ACK payloads, we need to enable dynamic payload lengths</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">setDynamicPayloads</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>    <span class="c1">// ACK payloads are dynamically sized</span>

  <span class="c1">// Acknowledgement packets have no payloads by default. We need to enable</span>
  <span class="c1">// this feature for all nodes (TX &amp; RX) to use ACK payloads.</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">enableAckPayload</span><span class="p">();</span>
  <span class="c1">// Fot this example, we use the same address to send data back and forth</span>

  <span class="c1">// set the TX address of the RX node into the TX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openWritingPipe</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">radioNumber</span><span class="p">]);</span>     <span class="c1">// always uses pipe 0</span>

  <span class="c1">// set the RX address of the TX node into a RX pipe</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">openReadingPipe</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">address</span><span class="p">[</span><span class="o">!</span><span class="n">radioNumber</span><span class="p">]);</span> <span class="c1">// using pipe 1</span>

  <span class="c1">// additional setup specific to the node&#39;s role</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// setup for TX mode</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>                                  <span class="c1">// put radio in TX mode</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// setup for RX mode</span>

    <span class="c1">// let IRQ pin only trigger on &quot;data ready&quot; event in RX mode</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">interruptConfig</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="c1">// args = dataReady, dataSent, dataFail</span>

    <span class="c1">// Fill the TX FIFO with 3 ACK payloads for the first 3 received</span>
    <span class="c1">// transmissions on pipe 1</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>

    <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span> <span class="c1">// put radio in RX mode</span>
  <span class="p">}</span>

  <span class="c1">// For debugging info</span>
  <span class="c1">// printf_begin();       // needed only once for printing details</span>
  <span class="c1">// radio.printDetails();</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">role</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wait_for_event</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// delay(1); // wait for IRQ pin to fully RISE</span>

    <span class="c1">// This device is a TX node. This if block is only triggered when</span>
    <span class="c1">// NOT waiting for an IRQ event to happen</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Test the &quot;data ready&quot; event with the IRQ pin</span>

      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Configuring IRQ pin to ignore the &#39;data sent&#39; event&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">interruptConfig</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="c1">// args = dataReady, dataSent, dataFail</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;   Pinging RX node for &#39;data ready&#39; event...&quot;</span><span class="p">));</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Test the &quot;data sent&quot; event with the IRQ pin</span>

      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Configuring IRQ pin to ignore the &#39;data ready&#39; event&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">interruptConfig</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="c1">// args = dataReady, dataSent, dataFail</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;   Pinging RX node for &#39;data sent&#39; event...&quot;</span><span class="p">));</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Use this iteration to fill the RX node&#39;s FIFO which sets us up for the next test.</span>

      <span class="c1">// send() uses virtual interrupt flags that work despite the masking of the IRQ pin</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">interruptConfig</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);;</span> <span class="c1">// disable IRQ masking for this step</span>

      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Sending 1 payload to fill RX node&#39;s FIFO. IRQ pin is neglected.&quot;</span><span class="p">));</span>
      <span class="c1">// send() will call flushTx() before calling write()</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_payloads</span><span class="p">[</span><span class="n">pl_iterator</span><span class="p">],</span> <span class="n">tx_pl_size</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">isFifo</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;RX node&#39;s FIFO is full; it is not listening any more&quot;</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Transmission successful, but the RX node might still be listening.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Transmission failed or timed out. Continuing anyway.&quot;</span><span class="p">));</span>
        <span class="n">radio</span><span class="p">.</span><span class="n">flushTx</span><span class="p">();</span> <span class="c1">// discard payload(s) that failed to transmit</span>
      <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// test the &quot;data fail&quot; event with the IRQ pin</span>

      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Configuring IRQ pin to reflect all events&quot;</span><span class="p">));</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">interruptConfig</span><span class="p">();</span> <span class="c1">// all args default to true</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;   Pinging inactive RX node for &#39;data fail&#39; event...&quot;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">pl_iterator</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// IRQ pin is LOW when activated. Otherwise it is always HIGH</span>
      <span class="c1">// Wait until IRQ pin is activated.</span>
      <span class="n">wait_for_event</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

      <span class="c1">// use the non-blocking call to write a payload and begin transmission</span>
      <span class="c1">// the &quot;false&quot; argument means we are expecting an ACK packet response</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">tx_payloads</span><span class="p">[</span><span class="n">pl_iterator</span><span class="o">++</span><span class="p">],</span> <span class="n">tx_pl_size</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

      <span class="c1">// In this example, the &quot;data fail&quot; event is always configured to</span>
      <span class="c1">// trigger the IRQ pin active. Because the auto-ACK feature is on by</span>
      <span class="c1">// default, we don&#39;t need a timeout check to prevent an infinite loop.</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// all IRQ tests are done; flushTx() and print the ACK payloads for fun</span>

      <span class="c1">// CE pin is still HIGH which consumes more power. Example is now idling so...</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span> <span class="c1">// ensure CE pin is LOW</span>
      <span class="c1">// stopListening() also calls flushTx() when ACK payloads are enabled</span>

      <span class="n">printRxFifo</span><span class="p">();</span>
      <span class="n">pl_iterator</span><span class="o">++</span><span class="p">;</span>


      <span class="c1">// inform user what to do next</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">*** PRESS &#39;T&#39; to restart the transmissions&quot;</span><span class="p">));</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** PRESS &#39;R&#39; to change to Receive role</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>


    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pl_iterator</span><span class="o">++</span><span class="p">;</span> <span class="c1">// proceed from step 3 to last step (stop at step 4 for readability)</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This device is a RX node</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">isFifo</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// wait until RX FIFO is full then stop listening</span>

      <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>             <span class="c1">// let ACK payload finish transmitting</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span>  <span class="c1">// also discards unused ACK payloads</span>
      <span class="n">printRxFifo</span><span class="p">();</span>          <span class="c1">// flush the RX FIFO</span>

      <span class="c1">// Fill the TX FIFO with 3 ACK payloads for the first 3 received</span>
      <span class="c1">// transmissions on pipe 1.</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>

      <span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>             <span class="c1">// let TX node finish its role</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span> <span class="c1">// We&#39;re ready to start over. Begin listening.</span>
    <span class="p">}</span>

  <span class="p">}</span> <span class="c1">// role</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// change the role via the serial monitor</span>

    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">Serial</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the TX node</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">role</span><span class="p">)</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO TRANSMIT ROLE -- PRESS &#39;R&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>
      <span class="k">else</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** RESTARTING IRQ PIN TEST ***&quot;</span><span class="p">));</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">wait_for_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">pl_iterator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// reset the iterator</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">flushTx</span><span class="p">();</span>  <span class="c1">// discard any payloads in the TX FIFO</span>

      <span class="c1">// startListening() clears the IRQ masks also. This is required for</span>
      <span class="c1">// continued TX operations when a transmission fails.</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">stopListening</span><span class="p">();</span> <span class="c1">// this also discards any unused ACK payloads</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">role</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Become the RX node</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;*** CHANGING TO RECEIVE ROLE -- PRESS &#39;T&#39; TO SWITCH BACK&quot;</span><span class="p">));</span>

      <span class="n">role</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

      <span class="n">radio</span><span class="p">.</span><span class="n">interruptConfig</span><span class="p">();</span> <span class="c1">// the IRQ pin should only trigger on &quot;data ready&quot; event</span>

      <span class="c1">// Fill the TX FIFO with 3 ACK payloads for the first 3 received</span>
      <span class="c1">// transmissions on pipe 1</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">flushTx</span><span class="p">();</span> <span class="c1">// make sure there is room for 3 new ACK payloads</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">writeAck</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_payloads</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ack_pl_size</span><span class="p">);</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// Serial.available()</span>
<span class="p">}</span> <span class="c1">// loop</span>


<span class="cm">/**</span>
<span class="cm"> * when the IRQ pin goes active LOW, call this fuction print out why</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">interruptHandler</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// print IRQ status and all masking flags&#39; states</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">IRQ pin is actively LOW&quot;</span><span class="p">));</span> <span class="c1">// show that this function was called</span>
  <span class="n">delayMicroseconds</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
  <span class="n">radio</span><span class="p">.</span><span class="n">clearStatusFlags</span><span class="p">();</span>        <span class="c1">// get values for IRQ masks</span>
  <span class="c1">// clearStatusFlags() clears the IRQ masks also. This is required for</span>
  <span class="c1">// continued TX operations when a transmission fails.</span>
  <span class="c1">// clearing the IRQ masks resets the IRQ pin to its inactive state (HIGH)</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">data_sent: &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDs</span><span class="p">());</span>                            <span class="c1">// print &quot;data sent&quot; mask state</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;, data_fail: &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDf</span><span class="p">());</span>                            <span class="c1">// print &quot;data fail&quot; mask state</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;, data_ready: &quot;</span><span class="p">));</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDr</span><span class="p">());</span>                          <span class="c1">// print &quot;data ready&quot; mask state</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDf</span><span class="p">())</span>                                      <span class="c1">// if TX payload failed</span>
    <span class="n">radio</span><span class="p">.</span><span class="n">flushTx</span><span class="p">();</span>                             <span class="c1">// clear all payloads from the TX FIFO</span>

  <span class="c1">// print if test passed or failed. Unintentional fails mean the RX node was not listening.</span>
  <span class="c1">// pl_iterator has already been incremented by now</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;   &#39;Data Ready&#39; event test &quot;</span><span class="p">));</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDr</span><span class="p">()</span> <span class="o">?</span> <span class="n">F</span><span class="p">(</span><span class="s">&quot;passed&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="n">F</span><span class="p">(</span><span class="s">&quot;failed&quot;</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;   &#39;Data Sent&#39; event test &quot;</span><span class="p">));</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDs</span><span class="p">()</span> <span class="o">?</span> <span class="n">F</span><span class="p">(</span><span class="s">&quot;passed&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="n">F</span><span class="p">(</span><span class="s">&quot;failed&quot;</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pl_iterator</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;   &#39;Data Fail&#39; event test &quot;</span><span class="p">));</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">irqDf</span><span class="p">()</span> <span class="o">?</span> <span class="n">F</span><span class="p">(</span><span class="s">&quot;passed&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="n">F</span><span class="p">(</span><span class="s">&quot;failed&quot;</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">wait_for_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// ready to continue with loop() operations</span>
<span class="p">}</span> <span class="c1">// interruptHandler</span>


<span class="cm">/**</span>
<span class="cm"> * Print the entire RX FIFO with one buffer. This will also flush the RX FIFO.</span>
<span class="cm"> * Remember that the payload sizes are declared as tx_pl_size and ack_pl_size.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">printRxFifo</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>                   <span class="c1">// if there is data in the RX FIFO</span>
    <span class="c1">// to flush the data from the RX FIFO, we&#39;ll fetch it all using 1 buffer</span>

    <span class="kt">uint8_t</span> <span class="n">pl_size</span> <span class="o">=</span> <span class="o">!</span><span class="n">role</span> <span class="o">?</span> <span class="nl">tx_pl_size</span> <span class="p">:</span> <span class="n">ack_pl_size</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">rx_fifo</span><span class="p">[</span><span class="n">pl_size</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>       <span class="c1">// RX FIFO is full &amp; we know ACK payloads&#39; size</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">isFifo</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">rx_fifo</span><span class="p">[</span><span class="n">pl_size</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// add a NULL terminating char to use as a c-string</span>
      <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_fifo</span><span class="p">,</span> <span class="n">pl_size</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// this clears the RX FIFO (for this example)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">radio</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">radio</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_fifo</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">pl_size</span><span class="p">),</span> <span class="n">pl_size</span><span class="p">);</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">rx_fifo</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">pl_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// add a NULL terminating char to use as a c-string</span>
    <span class="p">}</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;Complete RX FIFO: &quot;</span><span class="p">));</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">rx_fifo</span><span class="p">);</span>                 <span class="c1">// print the entire RX FIFO with 1 buffer</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cpp_examples.html" class="btn btn-neutral float-right" title="Linux examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to RF24 Revemped’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, 2bndy5

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>